const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

const fingersEl = document.getElementById("fingers");
const letterEl = document.getElementById("letter");

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

let drawing = false;
let path = [];

// ================= HANDS =================
const hands = new Hands({
  locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
});

hands.setOptions({
  maxNumHands: 1,
  modelComplexity: 1,
  minDetectionConfidence: 0.8,
  minTrackingConfidence: 0.8
});

// ================= RESULTS =================
hands.onResults(results => {
  if (!results.multiHandLandmarks) {
    fingersEl.textContent = 0;
    return;
  }

  const landmarks = results.multiHandLandmarks[0];
  const handedness = results.multiHandedness[0];

  const fingers = countFingers(landmarks, handedness);
  fingersEl.textContent = fingers;

  const x = (1 - landmarks[8].x) * canvas.width;
  const y = landmarks[8].y * canvas.height;

  ctx.strokeStyle = "#00f0ff";
  ctx.lineWidth = 4;
  ctx.lineCap = "round";

  // DESENHO COM RASTRO
  if (fingers === 1) {
    drawing = true;
    path.push({ x, y });

    if (path.length > 1) {
      ctx.beginPath();
      ctx.moveTo(path[path.length - 2].x, path[path.length - 2].y);
      ctx.lineTo(x, y);
      ctx.stroke();
    }
  }

  // FINALIZA DESENHO
  if (fingers === 0 && drawing) {
    drawing = false;
    recognizeLetter(path);
    path = [];
  }
});

// ================= CONTAR DEDOS (CORRETO) =================
function countFingers(landmarks, handedness) {
  let count = 0;
  const isRightHand = handedness.label === "Right";

  // POLEGAR (X)
  if (isRightHand) {
    if (landmarks[4].x > landmarks[3].x) count++;
  } else {
    if (landmarks[4].x < landmarks[3].x) count++;
  }

  // OUTROS DEDOS (Y)
  const tips = [8, 12, 16, 20];
  const bases = [6, 10, 14, 18];

  for (let i = 0; i < tips.length; i++) {
    if (landmarks[tips[i]].y < landmarks[bases[i]].y) {
      count++;
    }
  }

  return count;
}

// ================= RECONHECIMENTO SIMPLES =================
function recognizeLetter(points) {
  if (points.length < 15) return;

  const minX = Math.min(...points.map(p => p.x));
  const maxX = Math.max(...points.map(p => p.x));
  const minY = Math.min(...points.map(p => p.y));
  const maxY = Math.max(...points.map(p => p.y));

  const w = maxX - minX;
  const h = maxY - minY;

  let letter = "?";

  if (h > w * 1.5) letter = "I";
  else if (w > h * 1.5) letter = "-";
  else letter = "O";

  letterEl.textContent = letter;
}

// ================= CAMERA =================
const camera = new Camera(video, {
  onFrame: async () => {
    await hands.send({ image: video });
  },
  width: 1280,
  height: 720
});

camera.start();
